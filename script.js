// ================================
// LIFF ãƒ­ã‚°ã‚¤ãƒ³ãƒã‚§ãƒƒã‚¯
// ================================
async function liffLoginCheck() {
  // LIFF å†…ã§é–‹ã‹ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶å˜ä½“ã ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã®ã§ï¼‰
  if (!liff.isInClient()) {
    alert("ã“ã®æŠ½é¸ã¯ã€LINEã‚¢ãƒ—ãƒªå†…ã‹ã‚‰ã”åˆ©ç”¨ãã ã•ã„ã€‚");
    return false;
  }

  // æœªãƒ­ã‚°ã‚¤ãƒ³ãªã‚‰ãƒ­ã‚°ã‚¤ãƒ³ã•ã›ã‚‹
  if (!liff.isLoggedIn()) {
    liff.login();
    return false; // ã“ã“ã§ä¸€æ—¦å‡¦ç†çµ‚äº†ï¼ˆãƒ­ã‚°ã‚¤ãƒ³å¾Œã«æˆ»ã£ã¦ãã‚‹ï¼‰
  }

  return true;
}

// ================================
// æŠ½é¸å®Ÿè¡Œ
// ================================
function drawLottery() {
  const rand = Math.random() * 100;

  if (rand < 1.5) {
    return "ğŸ‰ã€1ç­‰ã€‘ã†ãªä¸¼ãƒ€ãƒ–ãƒ«ç„¡æ–™ï¼ï¼";
  } else if (rand < 1.5 + 2.5) {
    return "âœ¨ã€2ç­‰ã€‘ã†ãªä¸¼ç„¡æ–™ï¼";
  } else if (rand < 1.5 + 2.5 + 7) {
    return "ğŸ˜ã€3ç­‰ã€‘Tã‚·ãƒ£ãƒ„ or æ¹¯å‘‘ã¿";
  } else if (rand < 1.5 + 2.5 + 7 + 20) {
    return "ğŸ˜Šã€4ç­‰ã€‘ã‚³ãƒ¼ã‚¹ã‚¿ãƒ¼ or å·¾ç€";
  } else {
    return "ğŸ€ã€5ç­‰ã€‘ã‚­ãƒ¼ãƒ›ãƒ«ãƒ€ãƒ¼";
  }
}

// ================================
// ãƒœã‚¿ãƒ³æŠ¼ã•ã‚ŒãŸã¨ãã®å‹•ä½œ
// ================================
document.getElementById("drawBtn").addEventListener("click", async () => {
  // â‘  LIFF ãƒ­ã‚°ã‚¤ãƒ³ãƒ»ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒã‚§ãƒƒã‚¯
  const ok = await liffLoginCheck();
  if (!ok) return;

  // â‘¡ æŠ½é¸å®Ÿè¡Œ
  const resultText = drawLottery();

  // â‘¢ ãƒšãƒ¼ã‚¸ä¸Šã«è¡¨ç¤º
  document.getElementById("result").textContent = resultText;

  // â‘£ ãƒˆãƒ¼ã‚¯ã«çµæœãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
  //    â€»ã“ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ãƒˆãƒªã‚¬ãƒ¼ã«ã—ã¦ã€Little Help å´ã§ã‚¯ãƒ¼ãƒãƒ³è¿”ä¿¡ã•ã›ã‚‹
  const triggerMessage = `ã€å®‡å¥ˆã¨ã¨25å‘¨å¹´æŠ½é¸çµæœã€‘${resultText}`;

  try {
    await liff.sendMessages([
      {
        type: "text",
        text: triggerMessage
      }
    ]);
    // å¿…è¦ãªã‚‰ alert ãªã©ã§é€šçŸ¥ã—ã¦ã‚‚OK
    // alert("æŠ½é¸çµæœã‚’ãƒˆãƒ¼ã‚¯ã«é€ä¿¡ã—ã¾ã—ãŸï¼");
  } catch (e) {
    console.error("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã‚¨ãƒ©ãƒ¼", e);
    alert("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚LINEã‚¢ãƒ—ãƒªã‹ã‚‰é–‹ã„ã¦ã„ã‚‹ã‹ã”ç¢ºèªãã ã•ã„ã€‚");
  }
});
